

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>AutoGen for EAV &mdash; pylookml 2.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Dependency Graphing" href="dependency_graphing.html" />
    <link rel="prev" title="Cookbook / Examples" href="examples.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> pylookml
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Cookbook / Examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">AutoGen for EAV</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-is-eav">What is EAV?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#more-information-and-resources">More information and resources</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dependency_graphing.html">Dependency Graphing</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependency_graphing.html#what-does-this-do">What does this do?</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependency_graphing.html#basic-usage">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependency_graphing.html#functional-reference">Functional reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependency_graphing.html#how-does-this-work">How does this work?</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Full API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pylookml</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>AutoGen for EAV</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/eav.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="autogen-for-eav">
<h1>AutoGen for EAV<a class="headerlink" href="#autogen-for-eav" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-eav">
<h2>What is EAV?<a class="headerlink" href="#what-is-eav" title="Permalink to this headline">¶</a></h2>
<p>EAV data is storing key / value pairs in a table. It can allow application owners to hold data for which they can’t predict the columns or attributes at design time.
Common examples might include customizable objects (i.e. my users can add their own fields),or scientific data with many attributes or surveys.
EAV data allows flexibility, but can be notoriously difficult to perform analysis on. In this tutorial, we will show how pyLookML can be configured to create LookML for unpacking, imposing a permission structure
and allowing analysis on EAV data.</p>
<p><em>An Example of a configurable user profile table</em></p>
<p>Our example will follow a site with a configurable user profile. Organizations that use the site “Orgs” can add profile fields for their members so that admins can track org specific values for each of their user accounts.</p>
<p>Here is the sample data we’ll be using throughout. Imagine this sample data comes from a table called custom_profile_fields.</p>
<table class="colwidths-given docutils align-default" id="id1">
<caption><span class="caption-text">custom_profile_fields</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 26%" />
<col style="width: 26%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>user_id</p></th>
<th class="head"><p>org_id</p></th>
<th class="head"><p>field_name</p></th>
<th class="head"><p>value</p></th>
<th class="head"><p>datatype</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>8</p></td>
<td><p>c_donation_amount</p></td>
<td><p>40</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>8</p></td>
<td><p>c_highest_achievement</p></td>
<td><p>gold badge</p></td>
<td><p>varchar</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>101</p></td>
<td><p>c_highest_achievement</p></td>
<td><p>silver badge</p></td>
<td><p>varchar</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>101</p></td>
<td><p>c_monthly_contribution</p></td>
<td><p>300</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>101</p></td>
<td><p>c_highest_achievement</p></td>
<td><p>bronze badge</p></td>
<td><p>varchar</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>101</p></td>
<td><p>c_monthly_contribution</p></td>
<td><p>350</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>101</p></td>
<td><p>c_monthly_contribution</p></td>
<td><p>350</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>101</p></td>
<td><p>age</p></td>
<td><p>32</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>102</p></td>
<td><p>c_monthly_contribution</p></td>
<td><p>100</p></td>
<td><p>int</p></td>
</tr>
</tbody>
</table>
<p>You can see that the field name and value form the key,value relationship characteristic of EAV. Structured in a traditional table layout, we would need 4 columns to capture the 4 distinct custom fields:
c_donation_amount, c_highest_achievement, c_monthly_contribution, age.  And this would grow (as orgs and user accounts were added) to be much wider than is practical, or wider than the database may even allow a table to be.
However for analysis, we want to create a “slice” of this table for each org, showing them just their attributes as if it were a normal table.
Also notice that because the “value” column has mixed datatypes it must be a wide and neutral (typically a very wide varchar) and cast by the application when the record is read. Often by necessity you will often see the value paired with a column which tracks its type so the application can bind it to the right datatype at runtime.</p>
<p>Here is the LookML starting point (the script assumes that you have already created views for the relevant tables) but it will allow the ongoing programatic addition of fields.
We have a usr table which tracks basic information about our user accounts eav_source (which would be pointed at public.custom_profile_fields) and usr_profile which will track the extended profile attributes from custom_profile_fields (we’ll also permission the fields at the org level).
The explore usr, just associates our usr table to the usr profile table which will contain the un-packed EAV values. We have also added an access filter, so that our orgs can only see thier own records.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">connection</span><span class="o">:</span> <span class="s2">&quot;snowlooker&quot;</span>

<span class="nx">explore</span><span class="o">:</span> <span class="nx">usr</span> <span class="p">{</span>
    <span class="nx">access_filter</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">field</span><span class="o">:</span> <span class="nx">usr_profile</span><span class="p">.</span><span class="nx">org_id</span>
        <span class="nx">user_attribute</span><span class="o">:</span> <span class="nx">org_id</span>
    <span class="p">}</span>
    <span class="nx">join</span><span class="o">:</span> <span class="nx">usr_profile</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">left_outer</span>
        <span class="nx">relationship</span><span class="o">:</span> <span class="nx">one_to_one</span>
        <span class="nx">sql_on</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">usr</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">{</span><span class="nx">usr_profile</span><span class="p">.</span><span class="nx">user_id</span><span class="p">}</span> <span class="p">;;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">view</span><span class="o">:</span> <span class="nx">usr</span> <span class="p">{</span>
    <span class="nx">sql_table_name</span><span class="o">:</span> <span class="kr">public</span><span class="p">.</span><span class="nx">users</span> <span class="p">;;</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">email</span> <span class="p">{}</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">id</span> <span class="p">{}</span>
    <span class="nx">dimension_group</span><span class="o">:</span> <span class="nx">created</span> <span class="p">{</span> <span class="nx">timeframes</span><span class="o">:</span> <span class="p">[</span><span class="nx">raw</span><span class="p">,</span><span class="nx">date</span><span class="p">,</span><span class="nx">month</span><span class="p">,</span><span class="nx">year</span><span class="p">]</span> <span class="p">}</span>
<span class="p">}</span>

<span class="nx">view</span><span class="o">:</span> <span class="nx">usr_profile</span> <span class="p">{</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">org_id</span> <span class="p">{}</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">user_id</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="nx">view</span><span class="o">:</span> <span class="nx">eav_source</span> <span class="p">{</span>
    <span class="nx">sql_table_name</span><span class="o">:</span> <span class="kr">public</span><span class="p">.</span><span class="nx">custom_profile_fields</span> <span class="p">;;</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">datatype</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">string</span> <span class="p">}</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">field_name</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">string</span> <span class="p">}</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">org_id</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">number</span> <span class="p">}</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">user_id</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">number</span> <span class="p">}</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">value</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">string</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now for the automation code. First install the dependencies (FYI I highly reccoemnd using a virtual environment).
We will be using the <a class="reference external" href="https://github.com/looker-open-source/sdk-codegen/tree/master/python">Looker SDK</a> to run sql against the DB which will tell us what fields we need to create.
And we’ll install our pyLookML package as well.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install lookml, looker_sdk
</pre></div>
</div>
<p>create a file called api.ini in the directory where your python script will run to house the Looker API connection parameters:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Base URL for API. Do not include /api/* in the url</span>
<span class="nv">base_url</span> <span class="o">=</span> https://mylooker.looker.com:19999
<span class="c1"># API 3 client id</span>
<span class="nv">client_id</span><span class="o">=</span>put_your_client_id_here
<span class="c1"># API 3 client secret</span>
<span class="nv">client_secret</span><span class="o">=</span>put_your_sectret_here
<span class="c1"># Set to false if testing locally against self-signed certs. Otherwise leave True</span>
</pre></div>
</div>
<p>The automation python file follows these high level steps.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>connect to the Looker API to pull a list of EAV fields</p></li>
<li><p>create a pyLookML project connection to your github</p></li>
<li><p>Set up the objects we’ll be manipulating (some are just strings which will be added back to the LookML at the end)</p></li>
<li><p>loop over the list of EAV k,v pairs and do work</p></li>
<li><p>loop over the distinct raw columns (obtained in the full k,v loop) for adding columns to the NDT</p></li>
<li><p>loop over the distinct org ids to add the model’s access grants</p></li>
<li><p>add all the final objects back to the model file</p></li>
<li><p>save the file back to the project in github</p></li>
<li><p>hit the looker deploy URL to sync Looker production mode with the github master branch</p></li>
</ol>
</div></blockquote>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="kn">import</span> <span class="nn">lookml</span>
 <span class="kn">from</span> <span class="nn">looker_sdk</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">init31</span>

 <span class="c1"># step 1 -- connect to the Looker API to pull a list of EAV fields</span>
 <span class="n">sdk</span> <span class="o">=</span> <span class="n">init31</span><span class="p">(</span><span class="s2">&quot;api.ini&quot;</span><span class="p">)</span>
 <span class="n">sql_for_fields</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">         SELECT</span>
<span class="s2">              cpf.org_id</span>
<span class="s2">             ,cpf.value</span>
<span class="s2">             ,cpf.datatype</span>
<span class="s2">             ,cpf.field_name as &quot;FIELD_NAME&quot;</span>
<span class="s2">             , CASE</span>
<span class="s2">                 WHEN cpf.datatype IN (&#39;TIMESTAMP_LTZ&#39;) THEN &#39;time&#39;</span>
<span class="s2">                 WHEN cpf.datatype IN (&#39;FLOAT&#39;,&#39;NUMBER&#39;, &#39;int&#39;) THEN &#39;number&#39;</span>
<span class="s2">                 ELSE &#39;string&#39; END as &quot;LOOKER_TYPE&quot;</span>
<span class="s2">         FROM</span>
<span class="s2">             -- public.custom_profile_fields as cpf</span>
<span class="s2">             (</span>
<span class="s2">                 SELECT 1 as user_id, 8 as org_id, &#39;c_donation_amount&#39; as field_name, &#39;40&#39; as value, &#39;int&#39; as datatype UNION ALL</span>
<span class="s2">                 SELECT 1, 8, &#39;c_highest_achievement&#39;, &#39;gold badge&#39;, &#39;varchar&#39; UNION ALL</span>
<span class="s2">                 SELECT 2, 101, &#39;c_highest_achievement&#39;, &#39;silver badge&#39;, &#39;varchar&#39; UNION ALL</span>
<span class="s2">                 SELECT 2, 101, &#39;c_monthly_contribution&#39;, &#39;300&#39;, &#39;int&#39; UNION ALL</span>
<span class="s2">                 SELECT 3, 101, &#39;c_highest_achievement&#39;, &#39;bronze badge&#39;, &#39;varchar&#39; UNION ALL</span>
<span class="s2">                 SELECT 3, 101, &#39;c_monthly_contribution&#39;, &#39;350&#39;, &#39;int&#39; UNION ALL</span>
<span class="s2">                 SELECT 4, 101, &#39;c_monthly_contribution&#39;, &#39;350&#39;, &#39;int&#39; UNION ALL</span>
<span class="s2">                 SELECT 4, 101, &#39;age&#39;, &#39;32&#39;, &#39;int&#39; UNION ALL</span>
<span class="s2">                 SELECT 5, 102, &#39;c_monthly_contribution&#39;, &#39;100&#39;, &#39;int&#39;</span>
<span class="s2">             ) as cpf</span>
<span class="s2">         WHERE</span>
<span class="s2">             1=1</span>
<span class="s2">         GROUP BY 1,2,3,4,5</span>
<span class="s2"> &quot;&quot;&quot;</span>
 <span class="n">query_config</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">WriteSqlQueryCreate</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">sql_for_fields</span><span class="p">,</span> <span class="n">connection_id</span><span class="o">=</span><span class="s2">&quot;snowlooker&quot;</span><span class="p">)</span>
 <span class="n">query</span> <span class="o">=</span> <span class="n">sdk</span><span class="o">.</span><span class="n">create_sql_query</span><span class="p">(</span><span class="n">query_config</span><span class="p">)</span>
 <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">sdk</span><span class="o">.</span><span class="n">run_sql_query</span><span class="p">(</span><span class="n">slug</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span> <span class="n">result_format</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">))</span>

 <span class="c1"># step 2 -- create a pyLookML project connection to your github</span>
 <span class="n">proj</span> <span class="o">=</span> <span class="n">lookml</span><span class="o">.</span><span class="n">Project</span><span class="p">(</span>
         <span class="c1">#the github location of the repo</span>
             <span class="n">repo</span><span class="o">=</span> <span class="s1">&#39;llooker/russ_sanbox&#39;</span>
         <span class="c1">#instructions on creating an access token: https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line</span>
         <span class="p">,</span><span class="n">access_token</span><span class="o">=</span><span class="n">put_your_access_token_here</span>
         <span class="c1">#your Looker host</span>
         <span class="p">,</span><span class="n">looker_host</span><span class="o">=</span><span class="s2">&quot;https://mylooker.looker.com/&quot;</span>
         <span class="c1">#The name of the project on your looker host</span>
         <span class="p">,</span><span class="n">looker_project_name</span><span class="o">=</span><span class="s2">&quot;russ_sanbox&quot;</span>
         <span class="c1">#You can deploy to branches other than master, a shared or personal branch if you would like to hop into looker, pull</span>
         <span class="c1">#remote changes and review before the code is committed to production</span>
         <span class="p">,</span><span class="n">branch</span><span class="o">=</span><span class="s1">&#39;master&#39;</span>
 <span class="p">)</span>
 <span class="c1">#For simplicity of this example, all of the objects we&#39;re tracking will be contained in the model file, but for your needs can be split across the project.</span>
 <span class="n">modelFile</span> <span class="o">=</span> <span class="n">proj</span><span class="p">[</span><span class="s1">&#39;eav_example/eav.model.lkml&#39;</span><span class="p">]</span>

 <span class="c1"># step 3 -- Set up the objects we&#39;ll be manipulating (some are just strings which will be added back to the LookML at the end)</span>
 <span class="c1">#the EAV source view points to our custom_profile_fields database table</span>
 <span class="n">eavSource</span> <span class="o">=</span> <span class="n">modelFile</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">][</span><span class="s1">&#39;eav_source&#39;</span><span class="p">]</span>
 <span class="c1">#the user profile we&#39;ll call the &quot;flattening NDT&quot; since that&#39;s where our flattening logic lives</span>
 <span class="n">flatteningNDT</span> <span class="o">=</span> <span class="n">modelFile</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">][</span><span class="s1">&#39;usr_profile&#39;</span><span class="p">]</span>


 <span class="c1">#Ensure there is a hidden explore to expose the eav_souce transformations to our user_profile NDT</span>
 <span class="n">modelFile</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">     explore: _eav_flattener </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">         from: </span><span class="si">{</span><span class="n">eavSource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"></span>
<span class="s1">         hidden: yes</span>
<span class="s1">     </span><span class="se">}}</span><span class="s1"></span>
<span class="s1"> &#39;&#39;&#39;</span>
 <span class="c1">#Begin the derived table, will be added to as we loop through the fields</span>
 <span class="n">drivedtableString</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">     derived_table: </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">         explore_source: _eav_flattener </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">             column: user_id </span><span class="se">{{</span><span class="s1"> field: _eav_flattener.user_id </span><span class="se">}}</span><span class="s1"></span>
<span class="s1">             column: org_id </span><span class="se">{{</span><span class="s1"> field: _eav_flattener.org_id </span><span class="se">}}</span><span class="s1"></span>
<span class="s1"> &#39;&#39;&#39;</span>

 <span class="c1">#Set up a pair of list to track the unique org ids and column names</span>
 <span class="c1">#since the api query will be at a org / column level this allows us to &quot;de-dupe&quot;</span>
 <span class="n">orgIds</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

 <span class="c1"># step 4 -- loop over the list of EAV k,v pairs and do work</span>
 <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
     <span class="n">dimName</span> <span class="o">=</span> <span class="n">lookml</span><span class="o">.</span><span class="n">lookCase</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;FIELD_NAME&#39;</span><span class="p">])</span>
     <span class="n">orgIds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;ORG_ID&#39;</span><span class="p">])</span>
     <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dimName</span><span class="p">)</span>
     <span class="c1">#Step 1) Add flattening measure to the EAV source table</span>
     <span class="n">eavSource</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">             measure: </span><span class="si">{</span><span class="n">dimName</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">                 type: max</span>
<span class="s1">                 sql: CASE WHEN $</span><span class="se">{{</span><span class="s1">field_name</span><span class="se">}}</span><span class="s1"> = &#39;</span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;FIELD_NAME&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39; THEN $</span><span class="se">{{</span><span class="s1">value</span><span class="se">}}</span><span class="s1"> ELSE NULL END;;</span>
<span class="s1">             </span><span class="se">}}</span><span class="s1"></span>
<span class="s1">     &#39;&#39;&#39;</span>

     <span class="c1"># Add to the NDT fields</span>
     <span class="n">flatteningNDT</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">             dimension: </span><span class="si">{</span><span class="n">dimName</span><span class="si">}</span><span class="s1">_org_</span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;ORG_ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">                 label: &quot;</span><span class="si">{</span><span class="n">dimName</span><span class="si">}</span><span class="s1">&quot;</span>
<span class="s1">                 type: </span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;LOOKER_TYPE&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1"></span>
<span class="s1">                 sql: $</span><span class="se">{{</span><span class="s1">TABLE</span><span class="se">}}</span><span class="s1">.</span><span class="si">{</span><span class="n">dimName</span><span class="si">}</span><span class="s1"> ;;</span>
<span class="s1">                 required_access_grants: [org_</span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;ORG_ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1">]</span>
<span class="s1">             </span><span class="se">}}</span><span class="s1"></span>
<span class="s1">     &#39;&#39;&#39;</span>
     <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="s1">&#39;LOOKER_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">:</span>
         <span class="n">flatteningNDT</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">             measure: </span><span class="si">{</span><span class="n">dimName</span><span class="si">}</span><span class="s1">_total_org_</span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;ORG_ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">                 label: &quot;</span><span class="si">{</span><span class="n">dimName</span><span class="si">}</span><span class="s1">_total&quot;</span>
<span class="s1">                 type: sum</span>
<span class="s1">                 sql: $</span><span class="se">{{</span><span class="si">{</span><span class="n">dimName</span><span class="si">}</span><span class="s1">_org_</span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;ORG_ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="s1"> ;;</span>
<span class="s1">                 required_access_grants: [org_</span><span class="si">{</span><span class="n">column</span><span class="p">[</span><span class="s1">&#39;ORG_ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1">]</span>
<span class="s1">             </span><span class="se">}}</span><span class="s1"></span>
<span class="s1">         &#39;&#39;&#39;</span>
 <span class="c1"># step 5 -- loop over the distinct raw columns (obtained in the full k,v loop) for adding columns to the NDT</span>
 <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
     <span class="n">drivedtableString</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; column: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1"> field: _eav_flattener.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> </span><span class="se">}}</span><span class="s1">&#39;</span>
 <span class="n">drivedtableString</span> <span class="o">+=</span> <span class="s1">&#39;}}&#39;</span>

 <span class="c1"># step 6 -- loop over the distinct org ids to add the model&#39;s access grants</span>
 <span class="n">accessGrants</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
 <span class="k">for</span> <span class="n">org</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">orgIds</span><span class="p">):</span>
     <span class="n">accessGrants</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">         access_grant: org_</span><span class="si">{</span><span class="n">org</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1"></span>
<span class="s1">         user_attribute: org_id</span>
<span class="s1">         allowed_values: [</span>
<span class="s1">             &quot;</span><span class="si">{</span><span class="n">org</span><span class="si">}</span><span class="s1">&quot;</span>
<span class="s1">         ]</span>
<span class="s1">         </span><span class="se">}}</span><span class="s1"></span>
<span class="s1">     &#39;&#39;&#39;</span>
 <span class="c1"># step 7 -- add all the final objects back to the model file</span>
 <span class="c1">#Finish by adding some of the strings we&#39;ve been tracking:</span>
 <span class="n">flatteningNDT</span> <span class="o">+</span> <span class="n">drivedtableString</span>
 <span class="c1">#Add access grants to the model</span>
 <span class="n">modelFile</span> <span class="o">+</span> <span class="n">accessGrants</span>

 <span class="c1"># step 8 -- save the file back to the project in github</span>
 <span class="n">proj</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">modelFile</span><span class="p">)</span>
 <span class="c1">#s step 9 -- hit the looker deploy URL to sync Looker production mode with the github master branch</span>
 <span class="n">proj</span><span class="o">.</span><span class="n">deploy</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>The Completed LookML output to the eav.model.lkml file</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">connection</span><span class="o">:</span> <span class="s2">&quot;snowlooker&quot;</span>

<span class="nx">access_grant</span><span class="o">:</span> <span class="nx">org_8</span> <span class="p">{</span>
    <span class="nx">user_attribute</span><span class="o">:</span> <span class="nx">org_id</span>
    <span class="nx">allowed_values</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">&quot;8&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="nx">access_grant</span><span class="o">:</span> <span class="nx">org_101</span> <span class="p">{</span>
    <span class="nx">user_attribute</span><span class="o">:</span> <span class="nx">org_id</span>
    <span class="nx">allowed_values</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">&quot;101&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="nx">access_grant</span><span class="o">:</span> <span class="nx">org_102</span> <span class="p">{</span>
    <span class="nx">user_attribute</span><span class="o">:</span> <span class="nx">org_id</span>
    <span class="nx">allowed_values</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">&quot;102&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="nx">explore</span><span class="o">:</span> <span class="nx">usr</span> <span class="p">{</span>
    <span class="nx">access_filter</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">field</span><span class="o">:</span> <span class="nx">usr_profile</span><span class="p">.</span><span class="nx">org_id</span>
        <span class="nx">user_attribute</span><span class="o">:</span> <span class="nx">org_id</span>
    <span class="p">}</span>
    <span class="nx">join</span><span class="o">:</span> <span class="nx">usr_profile</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">left_outer</span>
        <span class="nx">relationship</span><span class="o">:</span> <span class="nx">one_to_one</span>
        <span class="nx">sql_on</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">usr</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span> <span class="o">=</span>  <span class="nx">$</span><span class="p">{</span><span class="nx">usr_profile</span><span class="p">.</span><span class="nx">user_id</span><span class="p">}</span> <span class="p">;;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">explore</span><span class="o">:</span> <span class="nx">_eav_flattener</span> <span class="p">{</span>
    <span class="nx">from</span><span class="o">:</span> <span class="nx">eav_source</span>
    <span class="nx">hidden</span><span class="o">:</span> <span class="nx">yes</span>
<span class="p">}</span>

<span class="nx">view</span><span class="o">:</span> <span class="nx">usr</span> <span class="p">{</span>
    <span class="nx">sql_table_name</span><span class="o">:</span> <span class="kr">public</span><span class="p">.</span><span class="nx">users</span> <span class="p">;;</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">email</span> <span class="p">{}</span>
    <span class="nx">dimension</span><span class="o">:</span> <span class="nx">id</span> <span class="p">{}</span>
    <span class="nx">dimension_group</span><span class="o">:</span> <span class="nx">created</span> <span class="p">{</span>
        <span class="nx">timeframes</span><span class="o">:</span> <span class="p">[</span>
            <span class="nx">raw</span><span class="p">,</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">month</span><span class="p">,</span> <span class="nx">year</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">time</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="nx">view</span><span class="o">:</span> <span class="nx">usr_profile</span> <span class="p">{</span>

<span class="nx">derived_table</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">explore_source</span><span class="o">:</span> <span class="nx">_eav_flattener</span> <span class="p">{</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">user_id</span> <span class="p">{</span> <span class="nx">field</span><span class="o">:</span> <span class="nx">_eav_flattener</span><span class="p">.</span><span class="nx">user_id</span><span class="p">}</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">org_id</span> <span class="p">{</span> <span class="nx">field</span><span class="o">:</span> <span class="nx">_eav_flattener</span><span class="p">.</span><span class="nx">org_id</span> <span class="p">}</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">c_donation_amount</span> <span class="p">{</span> <span class="nx">field</span><span class="o">:</span> <span class="nx">_eav_flattener</span><span class="p">.</span><span class="nx">c_donation_amount</span><span class="p">}</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">c_monthly_contribution</span> <span class="p">{</span> <span class="nx">field</span><span class="o">:</span> <span class="nx">_eav_flattener</span><span class="p">.</span><span class="nx">c_monthly_contribution</span> <span class="p">}</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">c_highest_achievement</span> <span class="p">{</span> <span class="nx">field</span><span class="o">:</span> <span class="nx">_eav_flattener</span><span class="p">.</span><span class="nx">c_highest_achievement</span> <span class="p">}</span>
    <span class="nx">column</span><span class="o">:</span> <span class="nx">age</span> <span class="p">{</span> <span class="nx">field</span><span class="o">:</span> <span class="nx">_eav_flattener</span><span class="p">.</span><span class="nx">age</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">age_org_101</span> <span class="p">{</span>
    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;age&quot;</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">number</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">TABLE</span><span class="p">}.</span><span class="nx">age</span> <span class="p">;;</span>
    <span class="nx">required_access_grants</span><span class="o">:</span> <span class="p">[</span><span class="nx">org_101</span><span class="p">,]</span>
    <span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">c_donation_amount_org_8</span> <span class="p">{</span>
    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;c_donation_amount&quot;</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">number</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">TABLE</span><span class="p">}.</span><span class="nx">c_donation_amount</span> <span class="p">;;</span>
    <span class="nx">required_access_grants</span><span class="o">:</span> <span class="p">[</span><span class="nx">org_8</span><span class="p">,]</span>
    <span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">c_highest_achievement_org_101</span> <span class="p">{</span>
    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;c_highest_achievement&quot;</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">string</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">TABLE</span><span class="p">}.</span><span class="nx">c_highest_achievement</span> <span class="p">;;</span>
    <span class="nx">required_access_grants</span><span class="o">:</span> <span class="p">[</span><span class="nx">org_101</span><span class="p">,]</span>
    <span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">c_highest_achievement_org_8</span> <span class="p">{</span>
    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;c_highest_achievement&quot;</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">string</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">TABLE</span><span class="p">}.</span><span class="nx">c_highest_achievement</span> <span class="p">;;</span>
    <span class="nx">required_access_grants</span><span class="o">:</span> <span class="p">[</span><span class="nx">org_8</span><span class="p">,]</span>
    <span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">c_monthly_contribution_org_101</span> <span class="p">{</span>
    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;c_monthly_contribution&quot;</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">number</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">TABLE</span><span class="p">}.</span><span class="nx">c_monthly_contribution</span> <span class="p">;;</span>
    <span class="nx">required_access_grants</span><span class="o">:</span> <span class="p">[</span><span class="nx">org_101</span><span class="p">,]</span>
    <span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">c_monthly_contribution_org_102</span> <span class="p">{</span>
    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;c_monthly_contribution&quot;</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">number</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">TABLE</span><span class="p">}.</span><span class="nx">c_monthly_contribution</span> <span class="p">;;</span>
    <span class="nx">required_access_grants</span><span class="o">:</span> <span class="p">[</span><span class="nx">org_102</span><span class="p">,]</span>
    <span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">org_id</span> <span class="p">{}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">user_id</span> <span class="p">{}</span>
<span class="nx">measure</span><span class="o">:</span> <span class="nx">age_total_org_101</span> <span class="p">{</span>
    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;age_total&quot;</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">sum</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">age_org_101</span><span class="p">}</span> <span class="p">;;</span>
    <span class="nx">required_access_grants</span><span class="o">:</span> <span class="p">[</span><span class="nx">org_101</span><span class="p">,]</span>
    <span class="p">}</span>
<span class="nx">measure</span><span class="o">:</span> <span class="nx">c_donation_amount_total_org_8</span> <span class="p">{</span>
    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;c_donation_amount_total&quot;</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">sum</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">c_donation_amount_org_8</span><span class="p">}</span> <span class="p">;;</span>
    <span class="nx">required_access_grants</span><span class="o">:</span> <span class="p">[</span><span class="nx">org_8</span><span class="p">,]</span>
    <span class="p">}</span>
<span class="nx">measure</span><span class="o">:</span> <span class="nx">c_monthly_contribution_total_org_101</span> <span class="p">{</span>
    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;c_monthly_contribution_total&quot;</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">sum</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">c_monthly_contribution_org_101</span><span class="p">}</span> <span class="p">;;</span>
    <span class="nx">required_access_grants</span><span class="o">:</span> <span class="p">[</span><span class="nx">org_101</span><span class="p">,]</span>
    <span class="p">}</span>
<span class="nx">measure</span><span class="o">:</span> <span class="nx">c_monthly_contribution_total_org_102</span> <span class="p">{</span>
    <span class="nx">label</span><span class="o">:</span> <span class="s2">&quot;c_monthly_contribution_total&quot;</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">sum</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">c_monthly_contribution_org_102</span><span class="p">}</span> <span class="p">;;</span>
    <span class="nx">required_access_grants</span><span class="o">:</span> <span class="p">[</span><span class="nx">org_102</span><span class="p">,]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">view</span><span class="o">:</span> <span class="nx">eav_source</span> <span class="p">{</span>
<span class="nx">sql_table_name</span><span class="o">:</span> <span class="kr">public</span><span class="p">.</span><span class="nx">custom_profile_fields</span> <span class="p">;;</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">datatype</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">string</span> <span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">field_name</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">string</span> <span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">org_id</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">number</span> <span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">user_id</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">number</span> <span class="p">}</span>
<span class="nx">dimension</span><span class="o">:</span> <span class="nx">value</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">string</span> <span class="p">}</span>

<span class="nx">measure</span><span class="o">:</span> <span class="nx">age</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">max</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">CASE</span> <span class="nx">WHEN</span> <span class="nx">$</span><span class="p">{</span><span class="nx">field_name</span><span class="p">}</span> <span class="o">=</span> <span class="s1">&#39;age&#39;</span> <span class="nx">THEN</span> <span class="nx">$</span><span class="p">{</span><span class="nx">value</span><span class="p">}</span> <span class="nx">ELSE</span> <span class="nx">NULL</span> <span class="nx">END</span> <span class="p">;;</span>
    <span class="p">}</span>
<span class="nx">measure</span><span class="o">:</span> <span class="nx">c_donation_amount</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">max</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">CASE</span> <span class="nx">WHEN</span> <span class="nx">$</span><span class="p">{</span><span class="nx">field_name</span><span class="p">}</span> <span class="o">=</span> <span class="s1">&#39;c_donation_amount&#39;</span> <span class="nx">THEN</span> <span class="nx">$</span><span class="p">{</span><span class="nx">value</span><span class="p">}</span> <span class="nx">ELSE</span> <span class="nx">NULL</span> <span class="nx">END</span> <span class="p">;;</span>
    <span class="p">}</span>
<span class="nx">measure</span><span class="o">:</span> <span class="nx">c_highest_achievement</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">max</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">CASE</span> <span class="nx">WHEN</span> <span class="nx">$</span><span class="p">{</span><span class="nx">field_name</span><span class="p">}</span> <span class="o">=</span> <span class="s1">&#39;c_highest_achievement&#39;</span> <span class="nx">THEN</span> <span class="nx">$</span><span class="p">{</span><span class="nx">value</span><span class="p">}</span> <span class="nx">ELSE</span> <span class="nx">NULL</span> <span class="nx">END</span> <span class="p">;;</span>
    <span class="p">}</span>
<span class="nx">measure</span><span class="o">:</span> <span class="nx">c_monthly_contribution</span> <span class="p">{</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">max</span>
    <span class="nx">sql</span><span class="o">:</span> <span class="nx">CASE</span> <span class="nx">WHEN</span> <span class="nx">$</span><span class="p">{</span><span class="nx">field_name</span><span class="p">}</span> <span class="o">=</span> <span class="s1">&#39;c_monthly_contribution&#39;</span> <span class="nx">THEN</span> <span class="nx">$</span><span class="p">{</span><span class="nx">value</span><span class="p">}</span> <span class="nx">ELSE</span> <span class="nx">NULL</span> <span class="nx">END</span> <span class="p">;;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="more-information-and-resources">
<h3>More information and resources<a class="headerlink" href="#more-information-and-resources" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ol class="arabic simple">
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=cdyn-KLwyfc">2019 Looker JOIN presentation on EAV and LookML Generation</a></p></li>
<li><p><a class="reference external" href="https://discourse.looker.com/t/three-ways-to-model-eav-schemas-and-many-to-many-relationships/1780">More about modeling EAV data in Looker</a></p></li>
</ol>
</div></blockquote>
<p>As an alternative to the MAX(CASE WHEN NAME=’foo’ THEN VALUE END) construct, you can use first / last value window functions. The specifics of the implementation may look slightly different.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">FIRST_VALUE</span><span class="p">(</span>
    <span class="k">CASE</span>
        <span class="k">WHEN</span> <span class="n">attributename</span> <span class="o">=</span> <span class="s1">&#39;single_type&#39;</span> <span class="k">THEN</span> <span class="n">attributevalue</span>
        <span class="k">ELSE</span> <span class="k">NULL</span>
    <span class="k">END</span>
<span class="k">IGNORE</span> <span class="n">NULLS</span><span class="p">)</span>
<span class="n">OVER</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">sessionid</span> <span class="k">order</span> <span class="k">by</span> <span class="n">sessionid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dependency_graphing.html" class="btn btn-neutral float-right" title="Dependency Graphing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="examples.html" class="btn btn-neutral float-left" title="Cookbook / Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Russell Garner

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>